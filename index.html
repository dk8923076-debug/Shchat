<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHCHAT | Final Europe Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50">

    <div id="auth-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center px-10">
        <h1 class="text-6xl font-black italic text-blue-600 mb-8 tracking-tighter">SHCHAT</h1>
        <div class="w-full max-w-sm space-y-3">
            <div id="signup-box" class="hidden">
                <input id="reg-name" type="text" placeholder="Full Name" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
            </div>
            <input id="auth-email" type="email" placeholder="Email" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
            <input id="auth-pass" type="password" placeholder="Password" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none">
            <button onclick="handleAuth()" id="auth-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-xl">Login</button>
            <p onclick="toggleAuth()" id="toggle-text" class="text-center text-blue-500 font-bold cursor-pointer mt-4 text-sm">Create Account</p>
        </div>
    </div>

    <div id="main-screen" class="hidden flex flex-col h-full max-w-md mx-auto bg-white border-x">
        <header class="p-5 border-b flex justify-between items-center bg-white sticky top-0 z-10 shadow-sm">
            <h2 class="text-2xl font-black italic text-blue-600">SHCHAT</h2>
            <button onclick="logout()" class="text-xs font-bold text-red-400">LOGOUT</button>
        </header>
        <div class="p-4 bg-white border-b">
            <input id="search-input" oninput="searchUsers()" type="text" placeholder="üîç Search friends..." class="w-full p-3 bg-gray-50 border-none rounded-xl outline-none text-sm">
        </div>
        <div id="user-list" class="flex-1 overflow-y-auto">
            <p class="text-center text-gray-400 mt-10 text-xs">Waiting for users...</p>
        </div>
    </div>

    <div id="chat-screen" class="hidden fixed inset-0 bg-white z-40 flex flex-col max-w-md mx-auto shadow-2xl">
        <header class="p-4 border-b flex items-center gap-4">
            <button onclick="closeChat()" class="text-blue-600 text-2xl">‚Üê</button>
            <h3 id="chat-title" class="font-bold">Chat</h3>
        </header>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-slate-50"></div>
        <div class="p-4 border-t flex gap-2">
            <input id="msg-input" type="text" placeholder="Type..." class="flex-1 bg-gray-100 rounded-full px-5 py-3 outline-none">
            <button onclick="sendMsg()" class="bg-blue-600 text-white p-3 rounded-full">‚û§</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAgxa0djoIwMYA9Nx7HIdRg_KifHnoEHdU",
          authDomain: "chating-app-c7c06.firebaseapp.com",
          // FIX: AAPKA EUROPE SERVER WALA LINK
          databaseURL: "https://chating-app-c7c06-default-rtdb.europe-west1.firebasedatabase.app/", 
          projectId: "chating-app-c7c06",
          storageBucket: "chating-app-c7c06.firebasestorage.app",
          messagingSenderId: "939070083870",
          appId: "1:939070083870:web:95bf5ef1495edb027caf0f"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const rtdb = firebase.database();

        let currentUser = null, targetUser = null, activeChatId = null, allUsers = [];

        function toggleAuth() {
            const isLogin = document.getElementById('signup-box').classList.toggle('hidden');
            document.getElementById('auth-btn').innerText = isLogin ? "Login" : "Create Account";
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const name = document.getElementById('reg-name').value;
            const isSignup = !document.getElementById('signup-box').classList.contains('hidden');
            try {
                if (isSignup) {
                    const res = await auth.createUserWithEmailAndPassword(email, pass);
                    await rtdb.ref('users/' + res.user.uid).set({ uid: res.user.uid, name: name, email: email });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (e) { alert(e.message); }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // Force sync user data to Database
                const snap = await rtdb.ref('users/' + user.uid).once('value');
                if(!snap.exists()) {
                    await rtdb.ref('users/' + user.uid).set({ uid: user.uid, name: user.email.split('@')[0], email: user.email });
                }
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-screen').classList.remove('hidden');
                loadUsers();
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-screen').classList.add('hidden');
            }
        });

        function loadUsers() {
            rtdb.ref('users').on('value', (snap) => {
                allUsers = [];
                snap.forEach(child => { if(child.key !== currentUser.uid) allUsers.push(child.val()); });
                renderList(allUsers);
            });
        }

        function renderList(list) {
            const container = document.getElementById('user-list');
            container.innerHTML = list.length === 0 ? "<p class='p-10 text-center text-gray-400 text-xs'>No users found in Europe Server.</p>" : "";
            list.forEach(user => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-4 p-5 hover:bg-blue-50 cursor-pointer border-b active:bg-gray-100";
                div.onclick = () => {
                    targetUser = user;
                    activeChatId = currentUser.uid < user.uid ? currentUser.uid + "_" + user.uid : user.uid + "_" + currentUser.uid;
                    document.getElementById('chat-screen').classList.remove('hidden');
                    document.getElementById('chat-title').innerText = user.name;
                    listenMessages();
                };
                div.innerHTML = `<div class='w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl'>${user.name[0].toUpperCase()}</div>
                                 <div class='flex-1'><h4 class='font-bold text-gray-800'>${user.name}</h4><p class='text-[10px] text-gray-400'>Click to Chat</p></div>`;
                container.appendChild(div);
            });
        }

        window.searchUsers = () => {
            const term = document.getElementById('search-input').value.toLowerCase();
            renderList(allUsers.filter(u => u.name.toLowerCase().includes(term)));
        }

        function listenMessages() {
            rtdb.ref('chats/' + activeChatId + '/messages').on('value', (snap) => {
                const mc = document.getElementById('chat-messages');
                mc.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const isMe = m.senderId === currentUser.uid;
                    mc.innerHTML += `<div class="p-3 my-1 rounded-2xl shadow-sm max-w-[80%] ${isMe ? 'bg-blue-600 text-white self-end' : 'bg-white text-black self-start'}">${m.text}</div>`;
                });
                mc.scrollTop = mc.scrollHeight;
            });
        }

        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) {
                rtdb.ref('chats/' + activeChatId + '/messages').push({ senderId: currentUser.uid, text: input.value, time: Date.now() });
                input.value = "";
            }
        }
        window.closeChat = () => document.getElementById('chat-screen').classList.add('hidden');
        window.logout = () => auth.signOut();
    </script>
</body>
</html>